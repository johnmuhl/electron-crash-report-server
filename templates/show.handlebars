<link rel="stylesheet" href="/assets/show.css" />

<h1><span>#</span>{{report.id}}</h1>

<div id="timestamps">
	<div>
		<img
			alt="created at"
			width="20"
			height="20"
			src="/assets/baseline-access_time-24px.svg"
		/>
		<span>
			{{report.created_at}}
		</span>
	</div>

	<div id="closed-at">
		<img
			alt="closed at"
			width="20"
			height="20"
			src="/assets/baseline-watch_later-24px.svg"
		/>
		<span>
			{{#if report.closed_at}} {{report.closed_at}} {{else}} — {{/if}}
		</span>
	</div>

	<div id="opened-duration">
		<img
			alt="open duration"
			width="20"
			height="20"
			src="/assets/baseline-timer-24px.svg"
		/>
		<span>
			{{report.opened_duration}}
		</span>
	</div>
</div>

<pre>{{report.body}}</pre>
<div id="actions">
	<button
		class="{{#if report.closed_at}}closed{{else}}opened{{/if}}"
		id="status-button"
		type="button"
	>
		{{#if report.closed_at}}
		<img alt="" width="20" height="20" src="/assets/baseline-replay-24px.svg" />
		<span>open</span>
		{{else}}
		<img alt="" width="20" height="20" src="/assets/baseline-check-24px.svg" />
		<span>close</span>
		{{/if}}
	</button>

	<a class="button" href="/r/{{report.id}}/stack">
		<img alt="" width="20" height="20" src="/assets/baseline-notes-24px.svg" />
		stack trace
	</a>

	<a class="button" href="/r/{{report.id}}/dump">
		<img alt="" width="20" height="20" src="/assets/baseline-save-24px.svg" />
		minidump
	</a>

	<button id="delete-button" type="button">
		<img
			alt=""
			width="20"
			height="20"
			src="/assets/baseline-delete_forever-24px.svg"
		/>
		delete
	</button>
</div>
<script type="module">
	const delete_button = document.querySelector("#delete-button");
	const status_button = document.querySelector("#status-button");

	status_button.addEventListener("click", async event => {
		try {
			const response = await fetch("/r/{{report.id}}", { method: "PATCH" });
			const {
				closed_active,
				closed_count: closed,
				opened_active,
				opened_count: opened,
				report,
			} = await response.json();
			const closed_at = document.querySelector("#closed-at span");
			const closed_count = document.querySelector("#closed-count span");
			const opened_duration = document.querySelector("#opened-duration span");
			const opened_count = document.querySelector("#opened-count span");

			closed_at.textContent = report.closed_at;
			closed_count.textContent = closed;
			opened_count.textContent = opened;
			opened_duration.textContent = report.opened_duration;

			if (report.closed_at !== "—") {
				status_button.classList.add("closed");
				status_button.classList.remove("opened");
				status_button.querySelector("span").textContent = "open";
				status_button.querySelector("img").src =
					"/assets/baseline-replay-24px.svg";
				closed_count.parentNode.classList.add("active");
				opened_count.parentNode.classList.remove("active");
			} else {
				status_button.classList.add("opened");
				status_button.classList.remove("closed");
				status_button.querySelector("span").textContent = "close";
				status_button.querySelector("img").src =
					"/assets/baseline-check-24px.svg";
				opened_count.parentNode.classList.add("active");
				closed_count.parentNode.classList.remove("active");
			}
		} catch (error) {
			throw error;
		}
	});

	delete_button.addEventListener("click", async event => {
		await fetch("/r/{{report.id}}", { method: "DELETE" });
		document.location.href = "/";
	});
</script>
